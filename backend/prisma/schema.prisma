// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum ProjectStatus {
  PLANNED
  ACTIVE
  COMPLETED
  ON_HOLD
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Models
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  avatar    String?
  bio       String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workspacesOwned Workspace[]        @relation("WorkspaceOwner")
  memberships     WorkspaceMember[]
  projectMemberships ProjectMember[]
  assignedTasks   Task[]             @relation("TaskAssignee")
  comments        TaskComment[]
  activities      Activity[]
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  description String?
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownerId    String
  owner      User      @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members    WorkspaceMember[]
  projects   Project[]
  activities Activity[]
  labels     Label[]

  @@index([ownerId])
}

model WorkspaceMember {
  // Composite primary key of user+workspace
  userId      String
  workspaceId String
  role        Role     @default(MEMBER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@id([userId, workspaceId])
  @@index([workspaceId])
  @@index([userId])
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNED)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks       Task[]
  members     ProjectMember[]
  activities  Activity[]

  @@index([workspaceId])
}

model ProjectMember {
  // Composite primary key of user+project
  userId    String
  projectId String
  role      Role     @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@id([userId, projectId])
  @@index([projectId])
  @@index([userId])
}

model Task {
  id          String       @id @default(uuid())
  number      Int?
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  assigneeId String?
  assignee   User?   @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  comments     TaskComment[]
  attachments  TaskAttachment[]

  // Task dependencies via explicit join table
  dependencies  TaskDependency[] @relation("TaskDependency_DependsOn")
  dependents    TaskDependency[] @relation("TaskDependency_Dependent")

  labels     TaskLabel[]

  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
}

model Label {
  id          String   @id @default(uuid())
  name        String
  color       String   @default("#6e7781")
  description String?
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  taskLabels  TaskLabel[]

  @@index([workspaceId])
  @@unique([workspaceId, name])
}

model TaskLabel {
  taskId  String
  labelId String
  addedAt DateTime @default(now())

  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([taskId, labelId])
  @@index([labelId])
}

// Explicit many-to-many join model to represent task dependencies and prevent circular references
model TaskDependency {
  taskId         String
  dependsOnTaskId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task        Task @relation("TaskDependency_Dependent", fields: [taskId], references: [id], onDelete: Cascade)
  dependsOn   Task @relation("TaskDependency_DependsOn", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

  @@id([taskId, dependsOnTaskId])
  @@index([dependsOnTaskId])
}

model TaskComment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taskId  String
  task    Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([authorId])
}

model TaskAttachment {
  id        String   @id @default(uuid())
  url       String
  fileName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model Activity {
  id          String   @id @default(uuid())
  action      String
  targetType  String
  targetId    String
  metadata    Json?    // Additional data like oldValue, newValue, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([projectId])
  @@index([userId])
}
